name: Deploy Privacy Module

on:
  workflow_dispatch:
    inputs:
      resource_group:
        description: Azure Resource Group
        required: true
        default: EISLAW-Dashboard
      webapp_name:
        description: Azure Web App name
        required: true
        default: eislaw-api-01
      storage_account:
        description: Azure Storage account (static website)
        required: true
        default: eislawstweb
      acr_name:
        description: Azure Container Registry name
        required: true
        default: eislawacr
      image_name:
        description: Container image repository
        required: true
        default: privacy-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push backend container
        working-directory: "EISLAW System"
        env:
          ACR_NAME: ${{ github.event.inputs.acr_name }}
          IMAGE_NAME: ${{ github.event.inputs.image_name }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          az acr build \
            -r "$ACR_NAME" \
            -t "${IMAGE_NAME}:${IMAGE_TAG}" \
            -f Dockerfile.api .

      - name: Update Web App container
        env:
          RESOURCE_GROUP: ${{ github.event.inputs.resource_group }}
          WEBAPP_NAME: ${{ github.event.inputs.webapp_name }}
          ACR_NAME: ${{ github.event.inputs.acr_name }}
          IMAGE_NAME: ${{ github.event.inputs.image_name }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          LOGIN_SERVER=$(az acr show -n "$ACR_NAME" --query loginServer -o tsv)
          IMAGE_REF="${LOGIN_SERVER}/${IMAGE_NAME}:${IMAGE_TAG}"
          az webapp config container set \
            -g "$RESOURCE_GROUP" \
            -n "$WEBAPP_NAME" \
            --container-image-name "$IMAGE_REF" \
            --container-registry-url "https://$LOGIN_SERVER" \
            --container-registry-user "$ACR_USERNAME" \
            --container-registry-password "$ACR_PASSWORD"
          az webapp config appsettings set \
            -g "$RESOURCE_GROUP" \
            -n "$WEBAPP_NAME" \
            --settings WEBSITES_PORT=8799
          az webapp restart -g "$RESOURCE_GROUP" -n "$WEBAPP_NAME"

      - name: Apply app settings
        run: |
          az webapp config appsettings set \
            -g "${{ github.event.inputs.resource_group }}" \
            -n "${{ github.event.inputs.webapp_name }}" \
            --settings \
              FILLOUT_API_KEY='${{ secrets.FILLOUT_API_KEY }}' \
              AIRTABLE_TOKEN='${{ secrets.AIRTABLE_TOKEN }}' \
              AIRTABLE_BASE_ID='${{ secrets.AIRTABLE_BASE_ID }}' \
              AIRTABLE_TABLE_ID='${{ secrets.AIRTABLE_TABLE_ID }}' \
              AIRTABLE_VIEW='${{ secrets.AIRTABLE_VIEW }}' \
              GRAPH_CLIENT_ID='${{ secrets.GRAPH_CLIENT_ID }}' \
              GRAPH_CLIENT_SECRET='${{ secrets.GRAPH_CLIENT_SECRET }}' \
              GRAPH_TENANT_ID='${{ secrets.GRAPH_TENANT_ID }}' \
              GRAPH_MAILBOX='${{ secrets.GRAPH_MAILBOX }}' \
              DEV_CORS_ORIGINS='https://${{ github.event.inputs.storage_account }}.z39.web.core.windows.net,http://localhost:5173,http://127.0.0.1:5173' \
              REPORT_LINK_HOST='https://${{ github.event.inputs.webapp_name }}.azurewebsites.net'

      - name: Verify backend health
        env:
          WEBAPP_NAME: ${{ github.event.inputs.webapp_name }}
        run: |
          for attempt in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$WEBAPP_NAME.azurewebsites.net/health" || true)
            if [ "$STATUS" = "200" ]; then
              echo "Backend healthy (200)."
              exit 0
            fi
            echo "Health check attempt $attempt failed (status=$STATUS). Retrying..."
            sleep 10
          done
          echo "Backend did not become healthy in time."
          exit 1

      - name: Build frontend
        working-directory: "EISLAW System/frontend"
        run: |
          npm ci
          npx vite build

      - name: Upload frontend to static website
        run: |
          az storage blob upload-batch \
            -s "EISLAW System/frontend/dist" \
            -d '$web' \
            --account-name "${{ github.event.inputs.storage_account }}" \
            --auth-mode login \
            --overwrite

      - name: Output endpoints
        run: |
          echo "API: https://${{ github.event.inputs.webapp_name }}.azurewebsites.net/health"
          echo "APP: https://${{ github.event.inputs.storage_account }}.z39.web.core.windows.net/#/privacy"
