<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://example.local/TASK_MAYA_EMAIL_BUGS_C006_C008/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Task: Fix Email Bugs C-006, C-007, C-008 - EISLAW Docs</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">EISLAW Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../INDEX/" class="nav-link">Index</a>
                            </li>
                            <li class="navitem">
                                <a href="../WORKING_MEMORY/" class="nav-link">Working Memory</a>
                            </li>
                            <li class="navitem">
                                <a href="../Testing_Episodic_Log/" class="nav-link">Episodic Log</a>
                            </li>
                            <li class="navitem">
                                <a href="../TEAM_INBOX/" class="nav-link">Team Inbox</a>
                            </li>
                            <li class="navitem">
                                <a href="../DEV_WORKFLOW_DIAGRAM/" class="nav-link">Development Workflow Diagram</a>
                            </li>
                            <li class="navitem">
                                <a href="../WORKFLOW_UPDATE_ANALYSIS/" class="nav-link">Workflow Update Analysis</a>
                            </li>
                            <li class="navitem">
                                <a href="../RESEARCH_SKILLS_ARCHITECTURE/" class="nav-link">Skills Architecture Research</a>
                            </li>
                            <li class="navitem">
                                <a href="../RESEARCH_VM_STORAGE_MIGRATION/" class="nav-link">VM Storage Migration Research</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#task-fix-email-bugs-c-006-c-007-c-008" class="nav-link">Task: Fix Email Bugs C-006, C-007, C-008</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#overview" class="nav-link">Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#bug-c-006-open-in-outlook-doesnt-navigate-to-email" class="nav-link">Bug C-006: "Open in Outlook" doesn't navigate to email</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#bug-c-007-reply-opens-empty-compose" class="nav-link">Bug C-007: "Reply" opens empty compose</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#bug-c-008-emailswidget-missing-scroll-click-to-view" class="nav-link">Bug C-008: EmailsWidget missing scroll + click-to-view</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="task-fix-email-bugs-c-006-c-007-c-008">Task: Fix Email Bugs C-006, C-007, C-008</h1>
<p><strong>Assigned To:</strong> Alex (Full-Stack)
<strong>From:</strong> Joe (CTO)
<strong>Date:</strong> 2025-12-06
<strong>Priority:</strong> P1 (C-006, C-007), P2 (C-008)
<strong>Status:</strong> ✅ Complete</p>
<blockquote>
<p><strong>Note:</strong> Reassigned from Maya to Alex for full-stack end-to-end ownership. Alex will handle both backend (if needed) and frontend, then self-verify via handshake protocol.</p>
</blockquote>
<hr />
<h2 id="overview">Overview</h2>
<p>Three email-related bugs need fixing in the Clients module. All are frontend issues.</p>
<hr />
<h2 id="bug-c-006-open-in-outlook-doesnt-navigate-to-email">Bug C-006: "Open in Outlook" doesn't navigate to email</h2>
<p><strong>Symptom:</strong> Clicking "Open in Outlook" opens Outlook web app but doesn't navigate to the specific email.</p>
<p><strong>File:</strong> <code>frontend/src/pages/Clients/ClientCard/ClientOverview.jsx</code></p>
<p><strong>Current Code (approx line 1290):</strong></p>
<pre><code class="language-javascript">function openEmailInOutlook(item){
  if(!item?.id) return
  const url = `https://outlook.office365.com/mail/deeplink/...`
  window.open(url, '_blank')
}
</code></pre>
<p><strong>Investigation:</strong>
1. Check what URL format is being generated
2. Compare with the OWA deeplink documentation
3. The email ID may need different encoding or the URL path may be wrong</p>
<p><strong>OWA Deeplink Formats:</strong>
- View email: <code>https://outlook.office365.com/mail/inbox/id/{encodedId}</code>
- Alternative: <code>https://outlook.office365.com/owa/?ItemID={encodedId}&amp;exvsurl=1&amp;viewmodel=ReadMessageItem</code></p>
<p><strong>Fix Approach:</strong>
1. Log the current URL being opened
2. Test different OWA URL formats
3. Ensure email ID is properly encoded (may need base64 or URL encoding)</p>
<hr />
<h2 id="bug-c-007-reply-opens-empty-compose">Bug C-007: "Reply" opens empty compose</h2>
<p><strong>Symptom:</strong> Clicking "Reply" opens OWA compose window but without the original email quoted.</p>
<p><strong>File:</strong> <code>frontend/src/pages/Clients/ClientCard/ClientOverview.jsx</code></p>
<p><strong>Current Code (approx line 1295):</strong></p>
<pre><code class="language-javascript">function replyInOutlook(item){
  if(!item?.id) return
  const replyUrl = `https://outlook.office365.com/mail/deeplink/compose?itemId=${encodeURIComponent(item.id)}&amp;action=reply`
  window.open(replyUrl, '_blank')
}
</code></pre>
<p><strong>Investigation:</strong>
1. The <code>action=reply</code> parameter may not work with <code>/deeplink/compose</code>
2. May need a different URL path entirely</p>
<p><strong>OWA Reply Formats to Try:</strong>
- <code>https://outlook.office365.com/mail/deeplink/reply?itemId={id}</code>
- <code>https://outlook.office365.com/owa/?ItemID={id}&amp;action=Reply</code></p>
<p><strong>Fix Approach:</strong>
1. Research correct OWA reply deeplink format
2. Test on VM with real email ID
3. Verify quoted content appears</p>
<hr />
<h2 id="bug-c-008-emailswidget-missing-scroll-click-to-view">Bug C-008: EmailsWidget missing scroll + click-to-view</h2>
<p><strong>Symptom:</strong> In the Overview tab, the EmailsWidget shows only 5 emails. Cannot scroll to see more. Cannot click to view email content.</p>
<p><strong>File:</strong> <code>frontend/src/components/EmailsWidget.jsx</code></p>
<p><strong>Current Behavior:</strong>
- Shows max 5 emails with "+X more" link
- Link navigates to emails tab (good)
- No way to view more inline
- No way to click email to see content</p>
<p><strong>Required Changes:</strong></p>
<ol>
<li>
<p><strong>Add Expand/Collapse:</strong>
   <code>jsx
   const [expanded, setExpanded] = useState(false)</code></p>
</li>
<li>
<p><strong>Add Scroll Container:</strong>
   ```jsx
 <br />
<div className={expanded ? "max-h-[400px] overflow-y-auto" : ""}>
   ```

3. **Fetch More When Expanded:**
   - When expanded=true, fetch with higher limit (e.g., 50)
   - Or remove limit entirely

4. **Add Click-to-View:**
   - Add onClick handler to each email row
   - Open inline viewer modal (similar to emails tab)
   - Include "Open in Outlook" and "Reply" buttons

**Reference:** Look at how ClientOverview.jsx emails tab handles the viewer:
- `viewer` state with `{ open, loading, error, html, meta }`
- `openViewer(email)` function
- Viewer modal component

---

## Testing

**On VM (http://20.217.86.4:5173):**

1. **C-006 Test:**
   - Go to Clients → Pick a client → Emails tab
   - Click "Open in Outlook" on any email
   - Verify: Outlook opens AND shows that specific email

2. **C-007 Test:**
   - Click "Reply" on any email
   - Verify: OWA compose opens with original email quoted

3. **C-008 Test:**
   - Go to Clients → Pick a client → Overview tab
   - Verify: Can expand to see more than 5 emails
   - Verify: Can scroll through emails
   - Verify: Can click email to view content inline

---

## Sync Commands


<pre><code class="language-bash"># Sync ClientOverview.jsx (C-006, C-007)
scp -i ~/.ssh/eislaw-dev-vm.pem frontend/src/pages/Clients/ClientCard/ClientOverview.jsx azureuser@20.217.86.4:~/EISLAWManagerWebApp/frontend/src/pages/Clients/ClientCard/

# Sync EmailsWidget.jsx (C-008)
scp -i ~/.ssh/eislaw-dev-vm.pem frontend/src/components/EmailsWidget.jsx azureuser@20.217.86.4:~/EISLAWManagerWebApp/frontend/src/components/
</code></pre>


Frontend uses hot-reload - no restart needed.

---

## Completion Report

**Completed by Alex - 2025-12-06**

| Bug | Status | Notes |
|-----|--------|-------|
| C-006 | ✅ FIXED | Backend: Updated `/email/open` to use `https://outlook.office365.com/owa/?ItemID={encoded_id}&exvsurl=1&viewmodel=ReadMessageItem` format. URL-encodes the Graph email ID for proper ItemID parameter. |
| C-007 | ✅ FIXED | Backend: Added `/email/reply` endpoint returning `https://outlook.office365.com/owa/?ItemID={encoded_id}&action=Reply&exvsurl=1`. Frontend: Updated `replyInOutlook` in ClientOverview.jsx to call new API endpoint. |
| C-008 | ✅ FIXED | Frontend: Updated `EmailsWidget.jsx` with simplified always-scrollable design: 1) Fixed height `max-h-[280px]` with `overflow-y-auto` - always scrollable 2) No expand/collapse button (per user request) 3) Fetches up to 100 emails 4) Click handler on email rows opens inline viewer 5) Viewer modal with Open in Outlook and Reply buttons (min-h-[44px]) |

**Files Modified:**
- `backend/main.py` - Updated `/email/open`, added `/email/reply`
- `frontend/src/components/EmailsWidget.jsx` - Simplified always-scrollable design (no expand button, fixed height with scroll)

**All files synced to VM.** Frontend hot-reload active.

---

*Task created by Joe (CTO) - 2025-12-06*
*Completed by Alex - 2025-12-06*


</p>
</li>
</ol></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
